<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>BAI 25-2 MAP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body { height: 100%; margin:0; padding:0; font-family: Arial; }
  #map { height: 100%; width: 100%; }

  /* === 패널 슬라이드 === */
  .panel {
    position: absolute;
    top: 60px; /* 버튼 밑으로 */
    left: 10px;
    z-index: 1000;
    width: 30%; /* 화면 30% */
    max-width: 300px;
    background: rgba(255,255,255,0.95);
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    overflow: hidden;
    transition: transform 0.3s ease, height 0.3s ease;
  }

  .panel.hidden {
    transform: translateX(-105%);
  }

  .panel-header {
    display: flex;
    border-bottom: 1px solid #ccc;
  }

  .panel-header button {
    flex: 1;
    padding: 6px 0;
    font-size: 14px;
    border: none;
    background: #f5f5f5;
    cursor: pointer;
  }

  .panel-header button.active {
    background: #ddd;
  }

  .panel-content {
    padding: 8px;
    display: none;
  }

  .panel-content.active {
    display: block;
  }

  .panel-content input, .panel-content button {
    width: 100%;
    margin: 4px 0;
    padding: 6px;
    font-size: 14px;
    box-sizing: border-box;
  }

  /* === 석삼자 버튼 → 일반 버튼 스타일 === */
  #panelToggle {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1100;
    padding: 6px 12px;
    font-size: 40px;
    border-radius: 6px;
    border: none;
    background-color: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    cursor: pointer;
  }

  /* 모바일 대응 */
  @media(max-width: 600px) {
    .panel { width: 70%; top: 60px; }
  }
</style>
</head>
<body>

<!-- 석삼자 버튼 대신 일반 버튼 -->
<button id="panelToggle">메뉴</button>

<!-- 패널 -->
<div class="panel hidden" id="slidePanel">
  <div class="panel-header">
    <button id="tabRegister" class="active">등록</button>
    <button id="tabFilter">조회</button>
  </div>
  <div class="panel-content active" id="registerContent">
    <input type="text" id="name" placeholder="이름">
    <input type="text" id="city" placeholder="도시">
    <label>시작일: <input type="date" id="startDate"></label>
    <label>종료일: <input type="date" id="endDate"></label>
    <button id="submitBtn">등록</button>
  </div>
  <div class="panel-content" id="filterContent">
    <label>조회 시작: <input type="date" id="startDateFilter"></label>
    <label>조회 종료: <input type="date" id="endDateFilter"></label>
    <button id="filterBtn">조회</button>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// 지도 초기화 (줌 컨트롤 제거)
const map = L.map('map', { zoomControl:false }).setView([36.5,127.8],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markers = L.layerGroup().addTo(map);
const cityCache = {};
const WORKER_URL = "https://curly-sun-6201.apineluk.workers.dev/";
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRy2Qr_9Zr-8rBE609BEd3GIj8fgaBclk2j2in0bBcoUeTS0bur0E_SN2Do8WrDYqfBd3xtdV9XvPai/pub?gid=147620371&single=true&output=csv";

const today = new Date().toISOString().split('T')[0];
document.getElementById('startDate').value = today;
document.getElementById('endDate').value = today;
document.getElementById('startDateFilter').value = today;
document.getElementById('endDateFilter').value = today;

// === 패널 토글 ===
const panelToggle = document.getElementById('panelToggle');
const slidePanel = document.getElementById('slidePanel');
panelToggle.addEventListener('click', ()=>{
  slidePanel.classList.toggle('hidden');
});

// === 탭 전환 ===
const tabRegister = document.getElementById('tabRegister');
const tabFilter = document.getElementById('tabFilter');
const registerContent = document.getElementById('registerContent');
const filterContent = document.getElementById('filterContent');

tabRegister.addEventListener('click', ()=>{
  tabRegister.classList.add('active');
  tabFilter.classList.remove('active');
  registerContent.classList.add('active');
  filterContent.classList.remove('active');
});

tabFilter.addEventListener('click', ()=>{
  tabFilter.classList.add('active');
  tabRegister.classList.remove('active');
  filterContent.classList.add('active');
  registerContent.classList.remove('active');
});

// === Geocode & Trips ===
async function geocode(city){
  if(cityCache[city]) return cityCache[city];
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city + ", South Korea")}`);
  const data = await res.json();
  if(data.length>0){
    const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    cityCache[city] = coords;
    return coords;
  }
  return null;
}

function isRangeOverlap(tripStart, tripEnd, filterStart, filterEnd){
  const ts = new Date(tripStart), te = new Date(tripEnd);
  const fs = new Date(filterStart), fe = new Date(filterEnd);
  return te >= fs && ts <= fe;
}

async function loadTrips(filterStart, filterEnd){
  markers.clearLayers();
  Papa.parse(SHEET_CSV,{
    download:true,
    header:true,
    complete: async function(results){
      const trips = results.data.filter(r=>r.name && r.city && r.startDate && r.endDate)
        .filter(t=>isRangeOverlap(t.startDate,t.endDate,filterStart,filterEnd));

      const cityMap = {};
      trips.forEach(t=>{
        if(!cityMap[t.city]) cityMap[t.city]=[];
        cityMap[t.city].push(t.name);
      });

      for(const city in cityMap){
        const coords = await geocode(city);
        if(coords) L.marker(coords).addTo(markers)
          .bindPopup(`<b>${city}</b><br>${cityMap[city].join("<br>")}`);
      }
    }
  });
}

// === Submit ===
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('name').value.trim();
  const city = document.getElementById('city').value.trim();
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  if(!name || !city || !startDate || !endDate){ alert("모든 항목 입력"); return; }

  try{
    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({name,city,startDate,endDate})
    });
    let result;
    try { result = await res.json(); } 
    catch(e){ result = {message:"저장 완료"}; }

    alert(result.message || "저장 완료");
    document.getElementById('name').value='';
    document.getElementById('city').value='';
    document.getElementById('startDate').value=today;
    document.getElementById('endDate').value=today;

    loadTrips(document.getElementById('startDateFilter').value, document.getElementById('endDateFilter').value);
  }catch(e){
    alert("저장 실패: "+e.message);
  }
});

// === Filter ===
document.getElementById('filterBtn').addEventListener('click', ()=>{
  const start = document.getElementById('startDateFilter').value;
  const end = document.getElementById('endDateFilter').value;
  loadTrips(start,end);
});

// 초기 로드
loadTrips(today,today);
</script>

</body>
</html>

