<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>출장 공유 MAP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html,body{height:100%;margin:0;font-family:Arial;} 
#map{height:100%;width:100%;} 
#loginPanel{position:absolute;top:0;left:0;width:100%;height:100%;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;} 
#loginPanel input{font-size:18px;padding:10px;margin:5px;width:200px;text-align:center;} 
#loginPanel button{font-size:18px;padding:10px 20px;cursor:pointer;margin-top:10px;} 
#myCode{position:absolute;bottom:10px;right:10px;background:rgba(255,255,255,0.8);padding:10px 15px;border-radius:10px;font-size:14px;display:none;}
.panel{position:absolute;top:10px;left:10px;z-index:1000;width:30%;max-width:300px;background:rgba(255,255,255,0.95);border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.3);overflow:hidden;display:none;}
.panel-header{display:flex;border-bottom:1px solid #ccc;}
.panel-header button{flex:1;padding:6px 0;font-size:14px;border:none;background:#f5f5f5;cursor:pointer;}
.panel-header button.active{background:#ddd;}
.panel-content{padding:8px;display:none;}
.panel-content.active{display:block;}
.panel-content input,.panel-content button{width:100%;margin:4px 0;padding:6px;font-size:14px;box-sizing:border-box;}
</style>
</head>
<body>
<div id="map"></div>

<!-- 로그인 패널 -->
<div id="loginPanel">
<h2>개인 코드 발급 / 로그인</h2>
<input type="text" id="userName" placeholder="이름 입력">
<input type="text" id="loginCode" placeholder="코드 입력 (선택)">
<button id="loginBtn">로그인 / 새 코드 발급</button>
</div>

<!-- 내 코드 표시 -->
<div id="myCode"></div>

<!-- 등록/조회 패널 -->
<div class="panel" id="mainPanel">
  <div class="panel-header">
    <button id="tabRegister" class="active">등록</button>
    <button id="tabFilter">조회</button>
  </div>
  <div class="panel-content active" id="registerContent">
    <input type="text" id="city" placeholder="도시">
    <label>시작일: <input type="date" id="startDate"></label>
    <label>종료일: <input type="date" id="endDate"></label>
    <button id="submitBtn">등록</button>
  </div>
  <div class="panel-content" id="filterContent">
    <label>조회 시작: <input type="date" id="startDateFilter"></label>
    <label>조회 종료: <input type="date" id="endDateFilter"></label>
    <button id="filterBtn">조회</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SCRIPT_URL = "https://curly-sun-6201.apineluk.workers.dev"; // Apps Script URL 입력
const today = new Date().toISOString().split('T')[0];
document.getElementById('startDate').value = today;
document.getElementById('endDate').value = today;
document.getElementById('startDateFilter').value = today;
document.getElementById('endDateFilter').value = today;

// 로그인 / 새 코드 발급
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('userName').value.trim();
  const inputCode = document.getElementById('loginCode').value.trim().toUpperCase();
  if(inputCode){
    // 기존 코드 로그인
    const res = await fetch(`${SCRIPT_URL}?action=login&code=${inputCode}`);
    const data = await res.json();
    if(data.success){
      localStorage.setItem('userCode', inputCode);
      document.getElementById('loginPanel').style.display='none';
      showMainUI(inputCode);
      return;
    } else alert("등록되지 않은 코드입니다. 새 코드 발급");
  }

  // 새 코드 발급
  const res2 = await fetch(`${SCRIPT_URL}?action=registerCode&name=${encodeURIComponent(name)}`);
  const data2 = await res2.json();
  if(data2.success){
    localStorage.setItem('userCode', data2.code);
    alert(`당신의 개인 코드: ${data2.code}`);
    document.getElementById('loginPanel').style.display='none';
    showMainUI(data2.code);
  } else alert("코드 발급 오류");
});

// 로그인 후 UI 표시
function showMainUI(code){
  document.getElementById('mainPanel').style.display='block';
  document.getElementById('myCode').innerText = `내 코드: ${code}`;
  document.getElementById('myCode').style.display='block';
  initMap(code);
}

// 지도 초기화 + 내 데이터 표시
async function initMap(code){
  const map = L.map('map').setView([36.5,127.8],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  
  // 기존 등록 데이터 로드
  const res = await fetch(`${SCRIPT_URL}?action=getData&code=${code}`);
  const data = await res.json();
  data.forEach(item=>{
    if(item.lat && item.lng){
      L.marker([item.lat,item.lng]).addTo(map)
        .bindPopup(`<b>${item.name}</b><br>${item.city}<br>${item.startDate} ~ ${item.endDate}`);
    }
  });
}

// 패널 탭 전환
const tabRegister = document.getElementById('tabRegister');
const tabFilter = document.getElementById('tabFilter');
const registerContent = document.getElementById('registerContent');
const filterContent = document.getElementById('filterContent');

tabRegister.addEventListener('click', ()=>{tabRegister.classList.add('active');tabFilter.classList.remove('active');registerContent.classList.add('active');filterContent.classList.remove('active');});
tabFilter.addEventListener('click', ()=>{tabFilter.classList.add('active');tabRegister.classList.remove('active');filterContent.classList.add('active');registerContent.classList.remove('active');});

// 날짜 초기화
document.getElementById('startDate').value = today;
document.getElementById('endDate').value = today;
document.getElementById('startDateFilter').value = today;
document.getElementById('endDateFilter').value = today;
</script>
</body>
</html>
