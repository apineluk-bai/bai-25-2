<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>출장 공유 MAP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html,body{height:100%;margin:0;font-family:Arial;}
#map{height:100%;width:100%;}
#loginPanel{position:absolute;top:0;left:0;width:100%;height:100%;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;}
#loginPanel input{font-size:18px;padding:10px;margin:5px;width:200px;text-align:center;}
#loginPanel button{font-size:18px;padding:10px 20px;cursor:pointer;margin-top:10px;}
#myCode{position:absolute;bottom:10px;right:10px;background:rgba(255,255,255,0.8);padding:10px 15px;border-radius:10px;font-size:14px;display:none;}
#panel{position:absolute;top:10px;left:10px;width:250px;background:white;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:none;}
#panel input,#panel button{width:100%;margin:4px 0;padding:6px;}
</style>
</head>
<body>
<div id="map"></div>

<div id="loginPanel">
<h2>개인 코드 발급 / 로그인</h2>
<input type="text" id="userName" placeholder="이름 입력">
<input type="text" id="loginCode" placeholder="코드 입력 (선택)">
<button id="loginBtn">로그인 / 새 코드 발급</button>
</div>

<div id="myCode"></div>

<div id="panel">
<h4>출장 등록</h4>
<input type="text" id="city" placeholder="도시">
<input type="date" id="startDate">
<input type="date" id="endDate">
<button id="submitBtn">등록</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw1nBAbcx0S6gVJ8dXGkZP0xxCsgHNtlY9p7j26gmDNEs0nLlqEJFpO6UBV4y1Jr-BUzw/exec";
const today = new Date().toISOString().split('T')[0];
document.getElementById('startDate').value = today;
document.getElementById('endDate').value = today;

// 로그인 / 새 코드 발급
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('userName').value.trim();
  const inputCode = document.getElementById('loginCode').value.trim().toUpperCase();
  if(inputCode){
    const res = await fetch(`${SCRIPT_URL}?action=login&code=${inputCode}`);
    const data = await res.json();
    if(data.success){
      localStorage.setItem('userCode', inputCode);
      document.getElementById('loginPanel').style.display='none';
      showMainUI(inputCode);
      return;
    } else alert("등록되지 않은 코드입니다. 새 코드 발급");
  }

  // 새 코드 발급
  const res2 = await fetch(`${SCRIPT_URL}?action=registerCode&name=${encodeURIComponent(name)}`);
  const data2 = await res2.json();
  if(data2.success){
    localStorage.setItem('userCode', data2.code);
    alert(`당신의 개인 코드: ${data2.code}`);
    document.getElementById('loginPanel').style.display='none';
    showMainUI(data2.code);
  } else alert("코드 발급 오류");
});

// 로그인 후 UI
function showMainUI(code){
  document.getElementById('panel').style.display='block';
  document.getElementById('myCode').innerText = `내 코드: ${code}`;
  document.getElementById('myCode').style.display='block';
  initMap(code);
}

// 지도 초기화
async function initMap(code){
  const map = L.map('map').setView([36.5,127.8],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const res = await fetch(`${SCRIPT_URL}?action=getData&code=${code}`);
  const data = await res.json();
  data.forEach(item=>{
    if(item.lat && item.lng){
      L.marker([item.lat,item.lng]).addTo(map)
        .bindPopup(`<b>${item.name}</b><br>${item.city}<br>${item.startDate} ~ ${item.endDate}`);
    }
  });
}

// 출장 등록 버튼
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const code = localStorage.getItem('userCode');
  const city = document.getElementById('city').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const res = await fetch(`${SCRIPT_URL}?action=addTrip&code=${code}&city=${encodeURIComponent(city)}&startDate=${startDate}&endDate=${endDate}`);
  const data = await res.json();
  if(data.success) alert("출장 등록 완료!"); 
  else alert("등록 실패");
});
</script>
</body>
</html>
