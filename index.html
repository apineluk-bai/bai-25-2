<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>BAI 25-2 MAP</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial; }
    #map { height: 100%; width: 100%; }
    .controls {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255,255,255,0.9); padding: 8px;
      border-radius: 5px; z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .controls input, .controls button { padding: 5px; font-size: 14px; margin-right: 5px; }
  </style>
</head>
<body>
  <div class="controls">
    <input type="text" id="name" placeholder="이름">
    <input type="text" id="city" placeholder="도시">
    <input type="date" id="date">
    <button id="submitBtn">등록</button>
    <br><br>
    <label>Start: <input type="date" id="startDate"></label>
    <label>End: <input type="date" id="endDate"></label>
    <button id="filterBtn">조회</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([36.5, 127.8], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markers = L.layerGroup().addTo(map);
    const cityCache = {};

    const SHEET_URL = "https://script.google.com/macros/s/AKfycbw7b6Y_5wvR7JNusiBAvTIoQruhP5Xjd149Jmmwo062LbD8lBRuLox-qPdRAMJfjlmjJQ/exec"; // 웹앱 URL

    // 한글/도시 이름 geocode
    async function geocode(city) {
      if(cityCache[city]) return cityCache[city];
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
      const data = await res.json();
      if(data.length>0){
        const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
        cityCache[city] = coords;
        return coords;
      }
      return null;
    }

    function isDateInRange(dateStr, startStr, endStr){
      const d = new Date(dateStr), s = new Date(startStr), e = new Date(endStr);
      const dDay = new Date(d.getFullYear(),d.getMonth(),d.getDate());
      const sDay = new Date(s.getFullYear(),s.getMonth(),s.getDate());
      const eDay = new Date(e.getFullYear(),e.getMonth(),e.getDate());
      return dDay>=sDay && dDay<=eDay;
    }

    async function loadTrips(start,end){
      markers.clearLayers();
      const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRy2Qr_9Zr-8rBE609BEd3GIj8fgaBclk2j2in0bBcoUeTS0bur0E_SN2Do8WrDYqfBd3xtdV9XvPai/pub?gid=147620371&single=true&output=csv";
      Papa.parse(csvUrl,{download:true,header:true,complete:async function(results){
        const trips = results.data.filter(r=>r.name && r.city && r.date)
          .filter(t=>isDateInRange(t.date,start,end));
        const cityMap = {};
        trips.forEach(t=>{
          if(!cityMap[t.city]) cityMap[t.city]=[];
          cityMap[t.city].push(t.name);
        });
        for(const city in cityMap){
          const coords = await geocode(city);
          if(coords) L.marker(coords).addTo(markers)
            .bindPopup(`<b>${city}</b><br>${cityMap[city].join("<br>")}`);
        }
      }});
    }

    // 오늘 날짜 기본값
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;

    // 등록 버튼
    document.getElementById('submitBtn').addEventListener('click', async ()=>{
      const name = document.getElementById('name').value;
      const city = document.getElementById('city').value;
      const date = document.getElementById('date').value;
      if(!name||!city||!date){ alert("모든 항목 입력"); return; }
      const res = await fetch(SHEET_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({name,city,date})
      });
      const result = await res.json();
      alert(result.message);
      document.getElementById('name').value='';
      document.getElementById('city').value='';
    });

    // 조회 버튼
    document.getElementById('filterBtn').addEventListener('click', ()=>{
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      loadTrips(start,end);
    });

    loadTrips(today,today);
  </script>
</body>
</html>

