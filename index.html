<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>출장 관리 MAP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html,body{height:100%;margin:0;font-family:Arial;}
#map{height:100%;width:100%;}
.panel{position:absolute;top:10px;left:10px;width:320px;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.3);z-index:1000;}
.panel-header{display:flex;border-bottom:1px solid #ccc;}
.panel-header button{flex:1;padding:6px 0;border:none;background:#f5f5f5;cursor:pointer;font-size:14px;}
.panel-header button.active{background:#ddd;}
.panel-content{padding:8px;display:none;}
.panel-content.active{display:block;}
input, button{width:100%;margin:4px 0;padding:6px;font-size:14px;box-sizing:border-box;}
label{font-size:13px;}
.trip-item{border-bottom:1px solid #ccc;padding:4px 0;}
.trip-item button{margin-top:2px;font-size:12px;}
</style>
</head>
<body>

<div class="panel">
  <div class="panel-header">
    <button id="tabRegister" class="active">등록</button>
    <button id="tabFilter">조회</button>
    <button id="tabMyTrips">내 출장</button>
  </div>

  <div class="panel-content active" id="tabRegisterContent">
    <input type="text" id="name" placeholder="이름 입력">
    <input type="text" id="city" placeholder="도시">
    <label>시작일: <input type="date" id="startDate"></label>
    <label>종료일: <input type="date" id="endDate"></label>
    <button id="submitBtn">등록</button>
  </div>

  <div class="panel-content" id="tabFilterContent">
    <label>조회 시작: <input type="date" id="startDateFilter"></label>
    <label>조회 종료: <input type="date" id="endDateFilter"></label>
    <button id="filterBtn">조회</button>
    <div id="filterResults"></div>
  </div>

  <div class="panel-content" id="tabMyTripsContent">
    내 출장 불러오는 중...
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const WORKER_URL = "https://curly-sun-6201.apineluk.workers.dev/";
const today = new Date().toISOString().split('T')[0];

// 날짜 초기화
document.getElementById('startDate').value = today;
document.getElementById('endDate').value = today;
document.getElementById('startDateFilter').value = today;
document.getElementById('endDateFilter').value = today;

// 탭 전환
const tabs = ["tabRegister","tabFilter","tabMyTrips"];
tabs.forEach(id=>{
  document.getElementById(id).addEventListener("click", ()=>{
    tabs.forEach(i=>{
      document.getElementById(i).classList.remove("active");
      document.getElementById(i+"Content").classList.remove("active");
    });
    document.getElementById(id).classList.add("active");
    document.getElementById(id+"Content").classList.add("active");
  });
});

// 지도 초기화
const map = L.map('map', { zoomControl:true }).setView([36.5,127.8],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markers = L.layerGroup().addTo(map);
const cityCache = {};

// 도시 좌표 가져오기
async function geocode(city){
  if(cityCache[city]) return cityCache[city];
  const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city+", South Korea")}`);
  const data = await res.json();
  if(data.length>0){ cityCache[city]=[parseFloat(data[0].lat), parseFloat(data[0].lon)]; return cityCache[city]; }
  return null;
}

// Worker 호출 함수
async function callWorker(params, method="GET"){
  let url = WORKER_URL;
  const options = { method, headers:{"Content-Type":"application/json"} };
  if(method==="GET"){
    url += "?" + new URLSearchParams(params).toString();
  } else {
    options.body = JSON.stringify(params);
  }
  const res = await fetch(url, options);
  return await res.json();
}

// 등록
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('name').value.trim();
  const city = document.getElementById('city').value.trim();
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  if(!name||!city||!startDate||!endDate){ alert("모든 항목 입력"); return; }

  const data = await callWorker({action:"registerCode", name, city, startDate, endDate}, "POST");
  if(data.success){
    alert(`등록 완료! 개인 코드: ${data.code}`);
    localStorage.setItem("userCode", data.code);
    localStorage.setItem("userName", name);
    loadMyTrips();
    loadFilterResults();
  } else alert("등록 실패");
});

// 조회
document.getElementById('filterBtn').addEventListener('click', loadFilterResults);
async function loadFilterResults(){
  const s = document.getElementById('startDateFilter').value;
  const e = document.getElementById('endDateFilter').value;
  const code = localStorage.getItem("userCode");
  if(!code) return;

  const trips = await callWorker({action:"getData", code}, "GET");
  const filtered = trips.filter(t=>t.startDate<=e && t.endDate>=s);
  const container = document.getElementById('filterResults');
  container.innerHTML = filtered.map(t=>`<div class="trip-item">${t.name} - ${t.city} (${t.startDate}~${t.endDate})</div>`).join('');

  markers.clearLayers();
  for(const t of filtered){
    if(t.city){
      const coords = await geocode(t.city);
      if(coords) L.marker(coords).addTo(markers).bindPopup(`<b>${t.name}</b><br>${t.city}<br>${t.startDate}~${t.endDate}`);
    }
  }
}

// 내 출장 불러오기
async function loadMyTrips(){
  const code = localStorage.getItem("userCode");
  if(!code) return;
  const trips = await callWorker({action:"getData", code}, "GET");
  const container = document.getElementById('tabMyTripsContent');
  if(trips.length===0) container.innerHTML="등록된 출장 없음";
  else container.innerHTML = trips.map(t=>`
    <div class="trip-item">
      <b>${t.city}</b> (${t.startDate}~${t.endDate})<br>
      <button onclick="editTrip('${t.code}')">수정</button>
      <button onclick="deleteTrip('${t.code}')">삭제</button>
    </div>
  `).join('');
}

// 출장 수정
async function editTrip(code){
  const newCity = prompt("도시 수정:");
  if(!newCity) return;
  const newStart = prompt("시작일 수정:");
  const newEnd = prompt("종료일 수정:");
  const name = localStorage.getItem("userName");
  const res = await callWorker({action:"addTrip", code, name, city:newCity, startDate:newStart, endDate:newEnd}, "PUT");
  alert(res.message);
  loadMyTrips();
  loadFilterResults();
}

// 출장 삭제
async function deleteTrip(code){
  if(!confirm("정말 삭제하시겠습니까?")) return;
  const res = await callWorker({action:"deleteTrip", code}, "DELETE");
  alert(res.message);
  loadMyTrips();
  loadFilterResults();
}

// 초기 로드
loadMyTrips();
loadFilterResults();
</script>
</body>
</html>
