<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>BAI 25-2 MAP</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body { height: 100%; margin:0; padding:0; font-family: Arial; }
  #map { height: 100%; width: 100%; }
  .controls {
    position: absolute; top: 10px; left: 10px;
    background: rgba(255,255,255,0.95); padding: 8px;
    border-radius: 5px; z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    max-width: 260px;
  }
  .controls input, .controls button { padding:5px; font-size:14px; margin-right:5px; margin-top:2px; }
  .controls hr { margin:5px 0; }
</style>
</head>
<body>

<div class="controls">
  <h4>등록</h4>
  <input type="text" id="name" placeholder="이름"><br>
  <input type="text" id="city" placeholder="도시"><br>
  <label>시작일: <input type="date" id="startDate"></label><br>
  <label>종료일: <input type="date" id="endDate"></label><br>
  <button id="submitBtn">등록</button>
  <hr>
  <h4>조회</h4>
  <label>조회 시작: <input type="date" id="startDateFilter"></label><br>
  <label>조회 종료: <input type="date" id="endDateFilter"></label><br>
  <button id="filterBtn">조회</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([36.5,127.8],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  const markers = L.layerGroup().addTo(map);
  const cityCache = {};
  const today = new Date().toISOString().split('T')[0];

  document.getElementById('startDate').value = today;
  document.getElementById('endDate').value = today;
  document.getElementById('startDateFilter').value = today;
  document.getElementById('endDateFilter').value = today;

  async function geocode(city){
    if(cityCache[city]) return cityCache[city];
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city + ", South Korea")}`);
    const data = await res.json();
    if(data.length>0){
      const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      cityCache[city] = coords;
      return coords;
    }
    return null;
  }

  function isRangeOverlap(tripStart, tripEnd, filterStart, filterEnd){
    const ts = new Date(tripStart), te = new Date(tripEnd);
    const fs = new Date(filterStart), fe = new Date(filterEnd);
    return te >= fs && ts <= fe;
  }

  function loadTrips(filterStart, filterEnd){
    markers.clearLayers();
    google.script.run.withSuccessHandler(trips => {
      const filtered = trips.filter(t => t.name && t.city && t.startDate && t.endDate)
        .filter(t => isRangeOverlap(t.startDate,t.endDate,filterStart,filterEnd));

      const cityMap = {};
      filtered.forEach(t => {
        if(!cityMap[t.city]) cityMap[t.city] = [];
        cityMap[t.city].push(t.name);
      });

      Object.keys(cityMap).forEach(async city => {
        const coords = await geocode(city);
        if(coords) L.marker(coords).addTo(markers)
          .bindPopup(`<b>${city}</b><br>${cityMap[city].join("<br>")}`);
      });
    }).getTrips();
  }

  document.getElementById('submitBtn').addEventListener('click', ()=>{
    const name = document.getElementById('name').value.trim();
    const city = document.getElementById('city').value.trim();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if(!name || !city || !startDate || !endDate){ alert("모든 항목 입력"); return; }

    google.script.run.withSuccessHandler(result => {
      alert(result.message || "저장 완료");
      document.getElementById('name').value='';
      document.getElementById('city').value='';
      document.getElementById('startDate').value=today;
      document.getElementById('endDate').value=today;
      loadTrips(document.getElementById('startDateFilter').value, document.getElementById('endDateFilter').value);
    }).saveTrip({name, city, startDate, endDate});
  });

  document.getElementById('filterBtn').addEventListener('click', ()=>{
    const start = document.getElementById('startDateFilter').value;
    const end = document.getElementById('endDateFilter').value;
    loadTrips(start,end);
  });

  loadTrips(today,today);
</script>
</body>
</html>
